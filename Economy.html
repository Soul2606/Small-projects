<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
	<h1>Economy</h1>
	<button id="button" onclick="advance_time()">Next</button>

	<div class="flex">
		<h3>Population</h3>
		<h3>10^</h3>
		<h3 id="population"></h3>
	</div>

	<h4 id="unemployment"></h4>

	<div class="flex" style="align-items: flex-start;">

		<div class="resources-list">	
			<h3>Commodities</h3>
			<p class="resources-list-name">organics</p>
			<p class="resources-list-amount" id="organics">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">cultivable soil</p>
			<p class="resources-list-amount" id="cultivable-soil">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">water</p>
			<p class="resources-list-amount" id="water">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">food</p>
			<p class="resources-list-amount" id="food">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">basic commodities</p>
			<p class="resources-list-amount" id="basic-commodities">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">luxury goods</p>
			<p class="resources-list-amount" id="luxury-goods">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">raw minerals</p>
			<p class="resources-list-amount" id="raw-minerals">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">metal ore</p>
			<p class="resources-list-amount" id="metal-ore">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">refined metal</p>
			<p class="resources-list-amount" id="refined-metal">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">heavy armaments</p>
			<p class="resources-list-amount" id="heavy-armaments">0</p>
			<div style="grid-column: 1/3; border: solid white 2px;"></div>
			<p class="resources-list-name">recreational drugs</p>
			<p class="resources-list-amount" id="recreational-drugs">0</p>
		</div>
	
		<div class="industry-list">
			<h3>Industries</h3>
			<h4>Size</h4>
			<h4>Jobs</h4>
			<p class="industry-list-name">water industry</p>
			<p class="industry-list-size" id="water-industry">0</p>
			<p class="industry-list-jobs" id="water-industry-jobs">0</p>
			<div style="grid-column: 1/4; border: solid white 2px;"></div>
			<p class="industry-list-name">farming</p>
			<p class="industry-list-size" id="farming">0</p>
			<p class="industry-list-jobs" id="farming-jobs">0</p>
			<div style="grid-column: 1/4; border: solid white 2px;"></div>
			<p class="industry-list-name">light industry</p>
			<p class="industry-list-size" id="light-industry">0</p>
			<p class="industry-list-jobs" id="light-industry-jobs">0</p>
			<div style="grid-column: 1/4; border: solid white 2px;"></div>
			<p class="industry-list-name">mining</p>
			<p class="industry-list-size" id="mining">0</p>
			<p class="industry-list-jobs" id="mining-jobs">0</p>
			<div style="grid-column: 1/4; border: solid white 2px;"></div>
			<p class="industry-list-name">refining</p>
			<p class="industry-list-size" id="refining">0</p>
			<p class="industry-list-jobs" id="refining-jobs">0</p>
			<div style="grid-column: 1/4; border: solid white 2px;"></div>
		</div>
	</div>
	

<style>



.resources-list{
	width: min-content;
	display: grid;
	grid-template-columns: auto auto;
	gap: 10px 25px;
	margin-right: 50px;
}

.resources-list-name{
	grid-column-start: 1;
	grid-column-end: 2;
	text-wrap: nowrap;
	margin: 0;
}

.resources-list-amount{
	grid-column-start: 2;
	grid-column-end: 3;
	text-wrap: nowrap;
	margin: 0;
}




.industry-list{
	width: min-content;
	display: grid;
	grid-template-columns: auto auto auto;
	gap: 10px 25px;
	margin-right: 50px;
}

.industry-list-name{
	grid-column-start: 1;
	grid-column-end: 2;
	text-wrap: nowrap;
	margin: 0;
}

.industry-list-size{
	grid-column-start: 2;
	grid-column-end: 3;
	text-wrap: nowrap;
	margin: 0;
}

.industry-list-jobs{
	grid-column-start: 3;
	grid-column-end: 4;
	text-wrap: nowrap;
	margin: 0;
}




</style>
<script>



class Economy {
	constructor(population, organics, cultivable_soil, water, food, basic_commodities, luxury_goods, raw_minerals, metal_ore, refined_metal, heavy_armaments, recreational_drugs){
		this.population =			population
		this.unemployed =			population
		this.commodities =			new Commodities(organics, cultivable_soil, water, food, basic_commodities, luxury_goods, raw_minerals, metal_ore, refined_metal, heavy_armaments, recreational_drugs)
		//Industry
		this.water_industry =		new Industry("water_industry", 6,	20,	0,	new Commodities())
		this.farming =				new Industry("farming", 6,	2,	0,	new Commodities(0,1))
		this.light_industry =		new Industry("light_industry", 6,	8,	0,	new Commodities(1))
		this.mining =				new Industry("mining", 6,	2,	0,	new Commodities("recreational_drugs,5"))
		this.refining =				new Industry("refining", 6,	8,	0,	new Commodities("raw_mineral,1,metal_ore,2"))/*raw_mineral, metal_ore*/
	}

	demand() {
		let all_requirements = new Commodities(0,0,this.population, this.population)
		all_requirements.add(this.water_industry.	consume.multiply(this.water_industry.	size))
		all_requirements.add(this.farming.			consume.multiply(this.farming.			size))
		all_requirements.add(this.light_industry.	consume.multiply(this.light_industry.	size))
		all_requirements.add(this.mining.			consume.multiply(this.mining.			size))
		all_requirements.add(this.refining.			consume.multiply(this.refining.			size))
		return all_requirements
	}

	get_total_available_jobs(){
		let total_available_jobs = 0
		total_available_jobs += this.water_industry.jobs - 	this.water_industry.employees
		total_available_jobs += this.farming.jobs - 			this.farming.employees
		total_available_jobs += this.light_industry.jobs - 	this.light_industry.employees
		total_available_jobs += this.mining.jobs - 			this.mining.employees
		total_available_jobs += this.refining.jobs - 		this.refining.employees
		return total_available_jobs
	}

	get_available_jobs_in_each_industry(){
		const object = {
			water_industry:	(this.water_industry.jobs - 	this.water_industry.employees),
			farming:		(this.farming.jobs - 			this.farming.employees),
			light_industry:	(this.light_industry.jobs - 	this.light_industry.employees),
			mining:			(this.mining.jobs - 			this.mining.employees),
			refining:		(this.refining.jobs - 			this.refining.employees)
		}
		return object
	}
}




class Commodities {
	constructor(organics = 0, cultivable_soil = 0, water = 0, food = 0, basic_commodities = 0, luxury_goods = 0, raw_minerals = 0, metal_ore = 0, refined_metal = 0, heavy_armaments = 0, recreational_drugs = 0){
		if(organics === undefined || !isNaN(organics)){
			this.organics =				organics,
			this.cultivable_soil =		cultivable_soil
			this.water =				water
			this.food =					food
			this.basic_commodities =	basic_commodities
			this.luxury_goods =			luxury_goods
			this.raw_minerals =			raw_minerals
			this.metal_ore =			metal_ore
			this.refined_metal =		refined_metal
			this.heavy_armaments =		heavy_armaments
			this.recreational_drugs =	recreational_drugs
		}else if(typeof organics === "string"){
			//This code is to make it easier to construct a new object with the values you want so you don't have to write 0,0,0,0,0,1
			this.organics =				0
			this.cultivable_soil =		0
			this.water =				0
			this.food =					0
			this.basic_commodities =	0
			this.luxury_goods =			0
			this.raw_minerals =			0
			this.metal_ore =			0
			this.refined_metal =		0
			this.heavy_armaments =		0
			this.recreational_drugs =	0

			let parsed_code = organics.split(",")
			for (let i = 0; i < parsed_code.length; i+=2) {
				const key = parsed_code[i]
				const value = Number(parsed_code[i + 1])
				this[key] = value
			}
		}
	}

	clone(){
		const new_commodities = new Commodities()
		new_commodities.organics = 				this.organics
		new_commodities.cultivable_soil = 		this.cultivable_soil
		new_commodities.water = 				this.water
		new_commodities.food = 					this.food
		new_commodities.basic_commodities = 	this.basic_commodities
		new_commodities.luxury_goods = 			this.luxury_goods
		new_commodities.raw_minerals = 			this.raw_minerals
		new_commodities.metal_ore = 			this.metal_ore
		new_commodities.refined_metal = 		this.refined_metal
		new_commodities.heavy_armaments = 		this.heavy_armaments
		new_commodities.recreational_drugs = 	this.recreational_drugs
		return new_commodities
	}

	add(value) {
		const new_commodities = this.clone()
		if(value instanceof Commodities){
			new_commodities.organics += 			value.organics
			new_commodities.cultivable_soil += 		value.cultivable_soil
			new_commodities.water += 				value.water
			new_commodities.food += 				value.food
			new_commodities.basic_commodities += 	value.basic_commodities
			new_commodities.luxury_goods += 		value.luxury_goods
			new_commodities.raw_minerals += 		value.raw_minerals
			new_commodities.metal_ore += 			value.metal_ore
			new_commodities.refined_metal += 		value.refined_metal
			new_commodities.heavy_armaments += 		value.heavy_armaments
			new_commodities.recreational_drugs += 	value.recreational_drugs
		}else if(typeof value === "number"){
			new_commodities.organics += 			value
			new_commodities.cultivable_soil += 		value
			new_commodities.water += 				value
			new_commodities.food += 				value
			new_commodities.basic_commodities += 	value
			new_commodities.luxury_goods += 		value
			new_commodities.raw_minerals += 		value
			new_commodities.metal_ore += 			value
			new_commodities.refined_metal += 		value
			new_commodities.heavy_armaments += 		value
			new_commodities.recreational_drugs += 	value
		}
		return new_commodities
	}

	multiply(value) {
		const new_commodities = this.clone()
		if(value instanceof Commodities){
			new_commodities.organics *= 			value.organics
			new_commodities.cultivable_soil *= 		value.cultivable_soil
			new_commodities.water *= 				value.water
			new_commodities.food *= 				value.food
			new_commodities.basic_commodities *= 	value.basic_commodities
			new_commodities.luxury_goods *= 		value.luxury_goods
			new_commodities.raw_minerals *= 		value.raw_minerals
			new_commodities.metal_ore *= 			value.metal_ore
			new_commodities.refined_metal *= 		value.refined_metal
			new_commodities.heavy_armaments *= 		value.heavy_armaments
			new_commodities.recreational_drugs *= 	value.recreational_drugs
		}else if(typeof value === "number"){
			new_commodities.organics *= 			value
			new_commodities.cultivable_soil *= 		value
			new_commodities.water *= 				value
			new_commodities.food *= 				value
			new_commodities.basic_commodities *= 	value
			new_commodities.luxury_goods *= 		value
			new_commodities.raw_minerals *= 		value
			new_commodities.metal_ore *= 			value
			new_commodities.refined_metal *= 		value
			new_commodities.heavy_armaments *= 		value
			new_commodities.recreational_drugs *= 	value
		}
		return new_commodities
	}

	divide(value) {
		const new_commodities = this.clone()
		if(value instanceof Commodities){
			new_commodities.organics /= 			value.organics
			new_commodities.cultivable_soil /= 	value.cultivable_soil
			new_commodities.water /= 				value.water
			new_commodities.food /= 				value.food
			new_commodities.basic_commodities /= 	value.basic_commodities
			new_commodities.luxury_goods /= 		value.luxury_goods
			new_commodities.raw_minerals /= 		value.raw_minerals
			new_commodities.metal_ore /= 			value.metal_ore
			new_commodities.refined_metal /= 		value.refined_metal
			new_commodities.heavy_armaments /= 	value.heavy_armaments
			new_commodities.recreational_drugs /= 	value.recreational_drugs
		}else if(typeof value === "number"){
			new_commodities.organics /= 			value
			new_commodities.cultivable_soil /= 	value
			new_commodities.water /= 				value
			new_commodities.food /= 				value
			new_commodities.basic_commodities /= 	value
			new_commodities.luxury_goods /= 		value
			new_commodities.raw_minerals /= 		value
			new_commodities.metal_ore /= 			value
			new_commodities.refined_metal /= 		value
			new_commodities.heavy_armaments /= 	value
			new_commodities.recreational_drugs /= 	value
		}
		return new_commodities
	}

}




class Industry {
	constructor(name, base_productivity = 1, space_efficiency = 1, size = 0, consume = new Commodities()){
		this.name =					name
		this.base_productivity =	base_productivity
		this.productivity =			base_productivity
		this.space_efficiency =		space_efficiency
		this.size =					size
		this.jobs =					this.size / this.productivity
		this.employees =			0
		this.consume =				consume
	}

	get_employment_factor() {
		let employees_per_job = this.employees / this.jobs
		isNaN(employees_per_job)? employees_per_job = 0:
		isFinite(employees_per_job)? do_nothing():employees_per_job = 0
		return employees_per_job
	}
}




function do_nothing(){
	//I swear this is needed! Trust me.
}




function clamp(value, min, max){
	let results = Math.min(max, Math.max(min, value))
	return isNaN(results) || results === Infinity? 0: results
}




function simplify(n){
    if(n < 1000){return Math.round(n)}
    let denom = 0
    const symbols = ["", "K", "M", "B", "T", "Qa", "Qu", "Sx", "Se", "Oc", "No"]
    while(n >= 1000){
        denom++
        n *= 0.001
    }

    let nr = n
    nr = Math.floor(nr)
    nr = nr.toString()
    let len = nr.length
    nr = 3 - len
    if(nr > 0){
        n = n.toFixed(nr)
    }
    else {
        n = Math.floor(n)
    }

    return n + symbols[denom]
}




function sum(input){
    let sum = 0;
    let values = [];

    // Check if input is an array or an object
    if (Array.isArray(input)) {
        values = input;
    } else if (typeof input === 'object') {
        values = Object.values(input);
    }

    for (let i = 0; i < values.length; i++) {
        const element = values[i];
        sum += element;
    }
    return sum;
}




function product(input){

	let values

	if (Array.isArray(input)) {
		values = input
	} else if(typeof input === "object"){
		values = Object.values(input)
	}

	if (values.length === 0) {
		return 0
	}
    let sum = values[0]
    for (let i = 1; i < values.length; i++) {
        const element = values[i];
        sum *= element
    }
    return sum
}




function distribute_positive_number(value, array){
	/*
	Function for distributing a number equally over an array without exceeding the array's set limit.
	Value and all array elements must be positive number.
	*/
	let results = []
	for (let i = 0; i < array.length; i++) {
		results.push(0)
	}

	let array_copy = Array.from(array)

	while(sum(array_copy) !== 0 && value > 0){

		let lowest_array_value = Infinity
		let lowest_array_index
		let amount_of_non_zero_items = 0
		for (let i = 0; i < array_copy.length; i++) {
			const element = array_copy[i];
			if(element !== 0){
				amount_of_non_zero_items++
				if (lowest_array_value > element){
					lowest_array_value = element
					lowest_array_index = i
				}
			}
		}

		const value_per_array = value / amount_of_non_zero_items
		const distribute_amount = Math.min(value_per_array, lowest_array_value)

		value -= distribute_amount * amount_of_non_zero_items

		for (let i = 0; i < results.length; i++) {
			if(array_copy[i] !== 0){
				results[i] += distribute_amount
				array_copy[i] -= distribute_amount
			}
		}
	}

	return results
}




function supply_demand_ratio(supply, demand){
	if (typeof supply === "number" && typeof demand === "number") {
		return clamp(supply / demand, 0, 1)
	}
	if (!Array.isArray(supply) && Array.isArray(demand)) {
		let results = []
		for (let i = 0; i < demand.length; i++) {
			const element = demand[i];
			results.push(clamp(supply / element, 0, 1))
		}
		return results
	}
	if (Array.isArray(supply) && !Array.isArray(demand)) {
		let results = []
		for (let i = 0; i < supply.length; i++) {
			const element = supply[i];
			results.push(clamp(element / demand, 0, 1))
		}
		return results
	}
	let results = []
	const max = Math.max(supply.length, demand.length)
	for (let i = 0; i < max; i++) {
		const supply_i = supply[i] === undefined? 0: supply[i];
		const demand_i = demand[i] === undefined? 0: demand[i];
		results.push(clamp(supply_i / demand_i, 0, 1))
	}
	return results
}




function update_resources_list(economy = new Economy()){

	document.getElementById("population").textContent = Math.floor(Math.log10(economy.population))

	document.getElementById("unemployment").textContent = (economy.unemployed / economy.population * 100) + "%"

	document.getElementById("organics").textContent = simplify(economy.commodities.organics)
	document.getElementById("cultivable-soil").textContent = simplify(economy.commodities.cultivable_soil)
	document.getElementById("water").textContent = simplify(economy.commodities.water)
	document.getElementById("food").textContent = simplify(economy.commodities.food)
	document.getElementById("basic-commodities").textContent = simplify(economy.commodities.basic_commodities)
	document.getElementById("luxury-goods").textContent = simplify(economy.commodities.luxury_goods)
	document.getElementById("raw-minerals").textContent = simplify(economy.commodities.raw_minerals)
	document.getElementById("metal-ore").textContent = simplify(economy.commodities.metal_ore)
	document.getElementById("refined-metal").textContent = simplify(economy.commodities.refined_metal)
	document.getElementById("heavy-armaments").textContent = simplify(economy.commodities.heavy_armaments)
	document.getElementById("recreational-drugs").textContent = simplify(economy.commodities.recreational_drugs)

	document.getElementById("water-industry").textContent =	Math.round(economy.water_industry.size)
	document.getElementById("farming").textContent =		Math.round(economy.farming.size)
	document.getElementById("light-industry").textContent =	Math.round(economy.light_industry.size)
	document.getElementById("mining").textContent =			Math.round(economy.mining.size)
	document.getElementById("refining").textContent =		Math.round(economy.refining.size)

	document.getElementById("water-industry-jobs").textContent =	economy.water_industry.employees + "/" + economy.water_industry.jobs
	document.getElementById("farming-jobs").textContent =			economy.farming.employees + "/" + economy.farming.jobs 
	document.getElementById("light-industry-jobs").textContent =	economy.light_industry.employees + "/" + economy.light_industry.jobs 
	document.getElementById("mining-jobs").textContent =			economy.mining.employees + "/" + economy.mining.jobs 
	document.getElementById("refining-jobs").textContent =			economy.refining.employees + "/" + economy.refining.jobs 

}




function employ_population(economy){

	const population = economy.population
	const unemployed = economy.unemployed

	const available_jobs_in_each_industry = Object.values(economy.get_available_jobs_in_each_industry())

	const people_being_employed_in_each_industry = distribute_positive_number(unemployed, available_jobs_in_each_industry)


	economy.unemployed -= sum(people_being_employed_in_each_industry)

	economy.water_industry.employees +=	people_being_employed_in_each_industry[0]
	economy.farming.employees +=		people_being_employed_in_each_industry[1]
	economy.light_industry.employees +=	people_being_employed_in_each_industry[2]
	economy.mining.employees +=			people_being_employed_in_each_industry[3]
	economy.refining.employees +=		people_being_employed_in_each_industry[4]
}




function population_interpreter(economy){

	economy.commodities.water -= Math.min(economy.population, economy.commodities.water)

	economy.commodities.food -= Math.min(economy.population, economy.commodities.food)
}




function general_industry_interpreter(industry, economy, industry_production_commodity){
	console.groupCollapsed("interpreter general industry:", industry.name)
	
	const demand = economy.demand()
	industry.size = Math.max(demand[industry_production_commodity] * 2 - economy.commodities[industry_production_commodity], 0)
	industry.jobs = Math.ceil(industry.size / industry.productivity)
	if(industry.jobs < industry.employees){
		economy.unemployed += industry.employees - industry.jobs
		industry.employees = industry.jobs
	}



	console.groupCollapsed("for loop")
	const commodities_consumed = industry.consume
	let commodities_consumed_satisfaction = []
	let commodities_consumed_keys = []
	console.log("looping over object:", commodities_consumed)
	for (let [key, value] of Object.entries(commodities_consumed)) {
		console.log("key", key, "value", value)
		if (value !== 0) {
			const satisfaction = clamp(economy.commodities[key] / (value * industry.size), 0, 1)
			commodities_consumed_satisfaction.push(satisfaction)
			commodities_consumed_keys.push(key)
		}
	}
	console.groupEnd()
	
	console.log("commodities_consumed_satisfaction",commodities_consumed_satisfaction)
	console.log("commodities_consumed_keys",commodities_consumed_keys)
	
	const consume_satisfaction = commodities_consumed_satisfaction.length === 0? 1: product(commodities_consumed_satisfaction)

	console.log("consume_satisfaction",consume_satisfaction)



	const industry_total_production = industry.size * industry.get_employment_factor() * consume_satisfaction

	economy.commodities[industry_production_commodity] += industry_total_production

	for (let i = 0; i < commodities_consumed_keys.length; i++) {
		const key = commodities_consumed_keys[i];
		
		economy.commodities[key] -= industry_total_production * industry.consume[key]

	}

	console.groupEnd()

}




function water_industry_interpreter(economy){
	
	general_industry_interpreter(economy.water_industry, economy, "water")
}




function farming_interpreter(economy){

	general_industry_interpreter(economy.farming, economy, "food")
}



const economy1 = new Economy(1000, 1200, 50000, 2000, 2500, 1000, 200, 0, 0, 0, 0, 500)

update_resources_list(economy1)

function advance_time(){
	console.group("advance time")

	employ_population(economy1)

	population_interpreter(economy1)

	water_industry_interpreter(economy1)

	farming_interpreter(economy1)
	
	update_resources_list(economy1)

	console.groupEnd()
}




</script>
</body>
</html>